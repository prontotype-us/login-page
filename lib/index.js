// Generated by CoffeeScript 1.10.0
var App, Dispatcher, ForgotForm, ForgotSuccess, IndexRoute, Link, LoginForm, LoginMixin, LoginPage, React, ResetForm, ResetSuccess, Route, Router, SignupForm, ValidatedFormMixin, _, browserHistory, confirm_password_field, email_field, fetch$, password_field, ref, setNext, token_field;

React = require('react');

_ = require('underscore');

ref = require('react-router'), Router = ref.Router, Route = ref.Route, IndexRoute = ref.IndexRoute, Link = ref.Link, browserHistory = ref.browserHistory;

fetch$ = require('kefir-fetch');

ValidatedFormMixin = require('validated-form').ValidatedFormMixin;

email_field = {
  name: 'email',
  type: 'email',
  icon: 'envelope',
  error_message: 'Please enter a valid email'
};

password_field = {
  name: 'password',
  type: 'password',
  icon: 'key',
  error_message: 'Please enter a password'
};

confirm_password_field = {
  name: 'confirm_password',
  type: 'password',
  icon: 'key',
  error_message: 'Confirm your password'
};

token_field = {
  name: 'reset_token',
  type: 'hidden',
  error_message: 'No reset token'
};

Dispatcher = {
  doSubmit: function(url, data) {
    return fetch$('post', url, {
      body: data
    });
  }
};

LoginMixin = {
  showNext: function(resp) {
    var next;
    next = this.props.location.query.next || '/';
    return window.location = next;
  },
  showSuccess: function() {
    return browserHistory.push({
      pathname: this.props.location.pathname + '/success',
      query: this.props.location.query
    });
  },
  handleError: function(resp) {
    return this.setState({
      errors: resp.errors
    });
  },
  onSubmit: function(values) {
    this.submitted$ = Dispatcher.doSubmit(this.url, values);
    this.submitted$.onValue(this.handleResponse);
    return this.submitted$.onError(this.handleError);
  }
};

LoginForm = React.createClass({displayName: "LoginForm",
  mixins: [ValidatedFormMixin, LoginMixin],
  url: '/login.json',
  fields: {
    email: email_field,
    password: password_field
  },
  getInitialState: function() {
    return {
      values: {
        email: '',
        password: ''
      },
      errors: {},
      loading: false
    };
  },
  handleResponse: function(resp) {
    if (resp.errors != null) {
      return this.handleError(resp);
    } else {
      return this.showNext();
    }
  },
  render: function() {
    return React.createElement("div", null, React.createElement("h3", null, "Log in"), React.createElement("form", {
      "onSubmit": this.trySubmit
    }, this.renderField('email'), this.renderField('password'), React.createElement("button", {
      "type": 'submit',
      "disabled": this.state.loading
    }, (this.state.loading ? 'Logging in...' : 'Log in'))));
  }
});

SignupForm = React.createClass({displayName: "SignupForm",
  mixins: [ValidatedFormMixin, LoginMixin],
  fields: {
    email: email_field,
    password: password_field
  },
  url: '/signup.json',
  getInitialState: function() {
    return {
      values: {
        email: '',
        password: ''
      },
      errors: {},
      loading: false
    };
  },
  handleResponse: function(resp) {
    if (resp.errors != null) {
      return this.handleError(resp);
    } else {
      return this.showNext();
    }
  },
  render: function() {
    return React.createElement("div", null, React.createElement("h3", null, "Sign up"), React.createElement("form", {
      "onSubmit": this.trySubmit
    }, this.renderField('email'), this.renderField('password'), React.createElement("button", {
      "type": 'submit',
      "disabled": this.state.loading
    }, (this.state.loading ? 'Signing up...' : 'Sign up'))));
  }
});

ForgotForm = React.createClass({displayName: "ForgotForm",
  mixins: [ValidatedFormMixin, LoginMixin],
  fields: {
    email: email_field
  },
  url: '/forgot.json',
  getInitialState: function() {
    return {
      values: {
        email: ''
      },
      errors: {},
      loading: false
    };
  },
  handleResponse: function(resp) {
    if (resp.errors != null) {
      return this.handleError(resp);
    } else {
      return this.showSuccess();
    }
  },
  render: function() {
    return React.createElement("form", {
      "onSubmit": this.trySubmit
    }, React.createElement("h3", null, "Forgot your password?"), this.renderField('email'), React.createElement("button", {
      "type": 'submit',
      "disabled": this.state.loading
    }, (this.state.loading ? 'Processing...' : 'Reset password')));
  }
});

ForgotSuccess = React.createClass({displayName: "ForgotSuccess",
  render: function() {
    return React.createElement("div", {
      "className": 'center'
    }, (options.forgot_success_view ? options.forgot_success_view : React.createElement("div", null, React.createElement("h3", null, "Check your email!"), React.createElement("p", null, "We sent you an email with instructions to reset your password."))));
  }
});

ResetForm = React.createClass({displayName: "ResetForm",
  mixins: [ValidatedFormMixin, LoginMixin],
  fields: {
    password: password_field,
    confirm_password: confirm_password_field,
    reset_token: token_field
  },
  url: '/reset.json',
  getInitialState: function() {
    return {
      values: {
        password: '',
        confirm_password: '',
        reset_token: this.props.params.reset_token || ''
      },
      errors: {},
      loading: false
    };
  },
  handleResponse: function(resp) {
    if (resp.errors != null) {
      return this.handleError(resp);
    } else {
      return this.showSuccess();
    }
  },
  render: function() {
    return React.createElement("form", {
      "onSubmit": this.trySubmit
    }, React.createElement("h3", null, "Set your password"), this.renderField('password'), this.renderField('confirm_password'), React.createElement("button", {
      "type": 'submit',
      "disabled": this.state.loading
    }, (this.state.loading ? 'Processing...' : 'Set password')));
  }
});

ResetSuccess = React.createClass({displayName: "ResetSuccess",
  render: function() {
    return React.createElement("div", {
      "className": 'center'
    }, (options.success_view ? options.success_view : React.createElement("div", null, React.createElement("h3", null, "Successfully set your password"), React.createElement("div", {
      "className": 'form-links'
    }, React.createElement(Link, {
      "to": {
        pathname: "/login",
        query: this.props.location.query
      }
    }, "Continue to login")))));
  }
});

App = React.createClass({displayName: "App",
  getInitialState: function() {
    return {
      active: 'login'
    };
  },
  render: function() {
    var links, path;
    console.log('[App.render]', this.props);
    path = this.props.routes.slice(-1)[0].name;
    if (!path.length || path === 'unknown') {
      path = 'login';
    }
    links = {
      login: React.createElement("div", {
        "className": 'form-links'
      }, (!options.hide_forgot ? React.createElement(Link, {
        "to": {
          pathname: "/forgot",
          query: this.props.location.query
        }
      }, "Forgot Password?") : void 0), (!options.hide_signup ? React.createElement(Link, {
        "to": {
          pathname: "/signup",
          query: this.props.location.query
        }
      }, "Don\'t have an account?") : void 0)),
      signup: React.createElement("div", {
        "className": 'form-links'
      }, (!options.hide_login ? React.createElement(Link, {
        "to": {
          pathname: "/login",
          query: this.props.location.query
        }
      }, "Already have an account?") : void 0)),
      forgot: React.createElement("div", {
        "className": 'form-links'
      }, (!options.hide_login ? React.createElement(Link, {
        "to": {
          pathname: "/login",
          query: this.props.location.query
        }
      }, "Â« Nevermind") : void 0), (this.props.has_signup ? React.createElement(Link, {
        "to": {
          pathname: "/signup",
          query: this.props.location.query
        }
      }, "Don\'t have an account?") : void 0)),
      reset: null
    };
    return React.createElement("div", {
      "id": 'login-module',
      "className": 'section'
    }, this.props.children, links[path]);
  }
});

window.options = {};

setNext = function(nextState, replace) {
  var next;
  next = nextState.location.pathname;
  return replace('/?next=' + next);
};

LoginPage = function(options) {
  var routes;
  _.extend(window.options, options);
  routes = React.createElement(Route, {
    "path": "/",
    "component": App
  }, React.createElement(IndexRoute, {
    "name": "login",
    "component": LoginForm
  }), React.createElement(Route, {
    "path": "login",
    "name": "login",
    "component": LoginForm
  }), React.createElement(Route, {
    "path": "reset/:reset_token",
    "name": "reset",
    "component": ResetForm
  }), React.createElement(Route, {
    "path": "reset/:reset_token/success",
    "name": "reset-success",
    "component": ResetSuccess
  }), React.createElement(Route, {
    "path": "welcome/:reset_token",
    "name": "reset",
    "component": ResetForm
  }), React.createElement(Route, {
    "path": "welcome/:reset_token/success",
    "name": "reset-success",
    "component": ResetSuccess
  }), (!options.hide_signup ? React.createElement(Route, {
    "path": "signup",
    "name": "signup",
    "component": SignupForm
  }) : void 0), (!options.hide_forgot ? React.createElement(Route, {
    "path": "forgot",
    "name": "forgot",
    "component": ForgotForm
  }) : void 0), (!options.hide_forgot ? React.createElement(Route, {
    "path": "forgot/success",
    "name": "forgot-success",
    "component": ForgotSuccess
  }) : void 0), options.extra_routes, React.createElement(Route, {
    "path": "*",
    "name": "unknown",
    "component": LoginForm,
    "onEnter": setNext
  }));
  return React.createElement(Router, {
    "routes": routes,
    "history": browserHistory
  });
};

module.exports = {
  LoginPage: LoginPage,
  LoginForm: LoginForm,
  SignupForm: SignupForm,
  ForgotForm: ForgotForm,
  ResetForm: ResetForm
};
